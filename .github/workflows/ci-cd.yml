name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: retrieval-agent

jobs:
  # ============================================================================
  # Unit Tests
  # ============================================================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -d "tests/unit" ]; then
            pytest tests/unit -v --cov=. --cov-report=xml --cov-report=term
          else
            echo "WARNING: No unit tests found, skipping..."
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # ============================================================================
  # Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run integration tests
        env:
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -d "tests/integration" ]; then
            pytest tests/integration -v
          else
            echo "WARNING: No integration tests found, skipping..."
          fi

  # ============================================================================
  # SAM Template Validation
  # ============================================================================
  validate-template:
    name: Validate SAM Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install AWS SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Validate SAM template
        run: |
          sam validate --lint
          echo "SAM template is valid"

  # ============================================================================
  # Build and Scan Docker Images
  # ============================================================================
  build-and-scan:
    name: Build and Scan Images
    runs-on: ubuntu-latest
    needs: [test-unit, validate-template]

    permissions:
      contents: read
      security-events: write

    outputs:
      research-image: ${{ steps.meta.outputs.research-tag }}
      transport-image: ${{ steps.meta.outputs.transport-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          echo "research-tag=research-agent:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "transport-tag=transport-agent:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build ResearchAgent Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./ResearchAgent/Dockerfile
          push: false
          tags: ${{ steps.meta.outputs.research-tag }}
          cache-from: type=gha,scope=research
          cache-to: type=gha,mode=max,scope=research
          load: true

      - name: Build TransportAgent Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./TransportAgent/Dockerfile
          push: false
          tags: ${{ steps.meta.outputs.transport-tag }}
          cache-from: type=gha,scope=transport
          cache-to: type=gha,mode=max,scope=transport
          load: true

      # - name: Run Trivy vulnerability scanner - ResearchAgent
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     image-ref: ${{ steps.meta.outputs.research-tag }}
      #     format: 'sarif'
      #     output: 'trivy-research-results.sarif'
      #     severity: 'CRITICAL,HIGH'
      #     exit-code: '0'

      # - name: Run Trivy vulnerability scanner - TransportAgent
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     image-ref: ${{ steps.meta.outputs.transport-tag }}
      #     format: 'sarif'
      #     output: 'trivy-transport-results.sarif'
      #     severity: 'CRITICAL,HIGH'
      #     exit-code: '0'

      # - name: Upload Trivy results to GitHub Security
      #   uses: github/codeql-action/upload-sarif@v3
      #   if: always()
      #   continue-on-error: true
      #   with:
      #     sarif_file: |
      #       trivy-research-results.sarif
      #       trivy-transport-results.sarif

      - name: Test ResearchAgent Container
        run: |
          echo "Testing ResearchAgent container imports..."
          docker run --rm --entrypoint python ${{ steps.meta.outputs.research-tag }} \
            -c "import lambda_handler; print('ResearchAgent imports successful')"

      - name: Test TransportAgent Container
        run: |
          echo "Testing TransportAgent container imports..."
          docker run --rm --entrypoint python ${{ steps.meta.outputs.transport-tag }} \
            -c "import lambda_handler; print('TransportAgent imports successful')"

  # ============================================================================
  # Push to ECR (if on master branches)
  # ============================================================================
  push-to-ecr:
    name: Push to ECR
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ResearchAgent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./ResearchAgent/Dockerfile
          push: true
          provenance: false
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:research-${{ github.sha }}
          cache-from: type=gha,scope=research
          cache-to: type=gha,mode=max,scope=research

      - name: Build and push TransportAgent
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./TransportAgent/Dockerfile
          push: true
          provenance: false
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:transport-${{ github.sha }}
          cache-from: type=gha,scope=transport
          cache-to: type=gha,mode=max,scope=transport

  # ============================================================================
  # Deploy to Production
  # ============================================================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test-integration, push-to-ecr]
    if: github.ref == 'refs/heads/master'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install AWS SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Get AWS Account ID
        id: account
        run: echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Verify ECR Images Exist
        run: |
          echo "## ECR Image Verification" >> $GITHUB_STEP_SUMMARY

          # Check ResearchAgent image
          RESEARCH_IMAGE="${{ steps.account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:research-${{ github.sha }}"
          echo "Verifying ResearchAgent image: $RESEARCH_IMAGE"

          if aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=research-${{ github.sha }} \
            --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
            echo "[OK] ResearchAgent image found in ECR" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] ResearchAgent image NOT found in ECR" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check TransportAgent image
          TRANSPORT_IMAGE="${{ steps.account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:transport-${{ github.sha }}"
          echo "Verifying TransportAgent image: $TRANSPORT_IMAGE"

          if aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=transport-${{ github.sha }} \
            --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
            echo "[OK] TransportAgent image found in ECR" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] TransportAgent image NOT found in ECR" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: SAM Deploy to Production (Main Stack)
        id: sam-deploy
        run: |
          # Generate deployment timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Deploying with timestamp: $TIMESTAMP"

          sam deploy \
            --stack-name retrieval-agent-stack \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --image-repository ${{ steps.account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }} \
            --parameter-overrides \
              Environment=prod \
              ImageTag=${{ github.sha }} \
              DeploymentTimestamp=$TIMESTAMP \
              LambdaExecutionRoleArn=arn:aws:iam::${{ steps.account.outputs.account_id }}:role/retrieval-agent-LambdaRole \
              GoogleMapsApiKey=${{ secrets.GOOGLE_MAPS_API_KEY }} \
              OpenAIApiKey=${{ secrets.OPENAI_API_KEY }} \
              AnthropicApiKey="${{ secrets.ANTHROPIC_API_KEY }}"
      - name: Show Stack Errors if Deploy Failed
        if: steps.sam-deploy.outcome == 'failure'
        run: |
          echo "## Deployment Failed - Stack Events" >> $GITHUB_STEP_SUMMARY
          aws cloudformation describe-stack-events \
            --stack-name retrieval-agent-stack \
            --region ${{ env.AWS_REGION }} \
            --query "StackEvents[?ResourceStatus=='CREATE_FAILED' || ResourceStatus=='UPDATE_FAILED'].[LogicalResourceId,ResourceStatusReason]" \
            --output table >> $GITHUB_STEP_SUMMARY || true

      - name: Verify Lambda Functions Updated
        if: steps.sam-deploy.outcome == 'success'
        run: |
          echo "## Lambda Update Verification" >> $GITHUB_STEP_SUMMARY

          # Wait for Lambda functions to stabilize
          sleep 5

          # Check ResearchAgent Lambda (API Handler)
          RESEARCH_STATUS=$(aws lambda get-function \
            --function-name research-agent-prod \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastUpdateStatus' \
            --output text)

          RESEARCH_HANDLER=$(aws lambda get-function-configuration \
            --function-name research-agent-prod \
            --region ${{ env.AWS_REGION }} \
            --query 'ImageConfigResponse.ImageConfig.Command[0]' \
            --output text)

          echo "ResearchAgent Lambda Status: $RESEARCH_STATUS"
          echo "ResearchAgent Handler: $RESEARCH_HANDLER"

          if [ "$RESEARCH_STATUS" = "Successful" ]; then
            echo "[OK] ResearchAgent Lambda updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "- Handler: \`$RESEARCH_HANDLER\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "[WARNING] ResearchAgent Lambda status: $RESEARCH_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

          # Check Research Processor Lambda (SQS Worker)
          PROCESSOR_STATUS=$(aws lambda get-function \
            --function-name research-processor-prod \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastUpdateStatus' \
            --output text 2>/dev/null || echo "NotFound")

          if [ "$PROCESSOR_STATUS" != "NotFound" ]; then
            PROCESSOR_HANDLER=$(aws lambda get-function-configuration \
              --function-name research-processor-prod \
              --region ${{ env.AWS_REGION }} \
              --query 'ImageConfigResponse.ImageConfig.Command[0]' \
              --output text)

            echo "Processor Lambda Status: $PROCESSOR_STATUS"
            echo "Processor Handler: $PROCESSOR_HANDLER"

            if [ "$PROCESSOR_STATUS" = "Successful" ]; then
              echo "[OK] Research Processor Lambda deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "- Handler: \`$PROCESSOR_HANDLER\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "[WARNING] Research Processor Lambda status: $PROCESSOR_STATUS" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "[INFO] Research Processor Lambda not yet deployed" >> $GITHUB_STEP_SUMMARY
          fi

          # Check TransportAgent Lambda
          TRANSPORT_STATUS=$(aws lambda get-function \
            --function-name transport-agent-prod \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastUpdateStatus' \
            --output text)

          echo "TransportAgent Lambda Status: $TRANSPORT_STATUS"
          if [ "$TRANSPORT_STATUS" = "Successful" ]; then
            echo "[OK] TransportAgent Lambda updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "[WARNING] TransportAgent Lambda status: $TRANSPORT_STATUS" >> $GITHUB_STEP_SUMMARY
          fi

          # Get image URIs to verify correct images are deployed
          RESEARCH_IMAGE=$(aws lambda get-function \
            --function-name research-agent-prod \
            --region ${{ env.AWS_REGION }} \
            --query 'Code.ImageUri' \
            --output text)

          TRANSPORT_IMAGE=$(aws lambda get-function \
            --function-name transport-agent-prod \
            --region ${{ env.AWS_REGION }} \
            --query 'Code.ImageUri' \
            --output text)

          echo "ResearchAgent Image: $RESEARCH_IMAGE" >> $GITHUB_STEP_SUMMARY
          echo "TransportAgent Image: $TRANSPORT_IMAGE" >> $GITHUB_STEP_SUMMARY

          # Verify images contain the correct SHA
          if [[ "$RESEARCH_IMAGE" == *"research-${{ github.sha }}"* ]]; then
            echo "[OK] ResearchAgent using correct image tag" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] ResearchAgent NOT using expected image tag" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [[ "$TRANSPORT_IMAGE" == *"transport-${{ github.sha }}"* ]]; then
            echo "[OK] TransportAgent using correct image tag" >> $GITHUB_STEP_SUMMARY
          else
            echo "[ERROR] TransportAgent NOT using expected image tag" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Force API Gateway Redeployment
        if: steps.sam-deploy.outcome == 'success'
        run: |
          echo "## API Gateway Redeployment" >> $GITHUB_STEP_SUMMARY

          # Get API Gateway ID from CloudFormation outputs
          API_ID=$(aws cloudformation describe-stacks \
            --stack-name retrieval-agent-stack \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text | grep -oP 'https://\K[^.]+')

          if [ -z "$API_ID" ]; then
            echo "[ERROR] Could not extract API Gateway ID from CloudFormation outputs" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "API Gateway ID: \`$API_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "API Gateway ID: $API_ID"

          # Get current stage deployment before redeployment
          OLD_DEPLOYMENT_ID=$(aws apigateway get-stage \
            --rest-api-id $API_ID \
            --stage-name prod \
            --region ${{ env.AWS_REGION }} \
            --query 'deploymentId' \
            --output text)

          echo "Previous deployment ID: \`$OLD_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY

          # Force create new API Gateway deployment
          echo "Creating new API Gateway deployment..." >> $GITHUB_STEP_SUMMARY
          NEW_DEPLOYMENT_ID=$(aws apigateway create-deployment \
            --rest-api-id $API_ID \
            --stage-name prod \
            --description "Auto-deployment for commit ${{ steps.short-sha.outputs.short_sha }} at $(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --region ${{ env.AWS_REGION }} \
            --query 'id' \
            --output text)

          if [ -z "$NEW_DEPLOYMENT_ID" ]; then
            echo "[ERROR] Failed to create new API Gateway deployment" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "New deployment ID: \`$NEW_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "New API Gateway deployment ID: $NEW_DEPLOYMENT_ID"

          # Wait for deployment to propagate
          echo "Waiting for deployment to propagate..."
          sleep 5

          # Verify the stage is using the new deployment
          ACTIVE_DEPLOYMENT_ID=$(aws apigateway get-stage \
            --rest-api-id $API_ID \
            --stage-name prod \
            --region ${{ env.AWS_REGION }} \
            --query 'deploymentId' \
            --output text)

          STAGE_UPDATED=$(aws apigateway get-stage \
            --rest-api-id $API_ID \
            --stage-name prod \
            --region ${{ env.AWS_REGION }} \
            --query 'lastUpdatedDate' \
            --output text)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Result" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Deployment**: \`$OLD_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- **New Deployment**: \`$NEW_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Active Deployment**: \`$ACTIVE_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Stage Last Updated**: \`$STAGE_UPDATED\`" >> $GITHUB_STEP_SUMMARY

          if [ "$ACTIVE_DEPLOYMENT_ID" = "$NEW_DEPLOYMENT_ID" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[OK] API Gateway redeployed successfully to \`$NEW_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[ERROR] Active deployment (\`$ACTIVE_DEPLOYMENT_ID\`) does not match new deployment (\`$NEW_DEPLOYMENT_ID\`)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Get Stack Outputs
        run: |
          echo "## Deployment Outputs" >> $GITHUB_STEP_SUMMARY

          echo "### Main Stack" >> $GITHUB_STEP_SUMMARY
          aws cloudformation describe-stacks \
            --stack-name retrieval-agent-stack \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output table >> $GITHUB_STEP_SUMMARY


      - name: Rollback on failure
        if: failure()
        continue-on-error: true
        run: |
          echo "##Initiating Rollback" >> $GITHUB_STEP_SUMMARY
          aws cloudformation cancel-update-stack \
          --stack-name retrieval-agent-stack \
          --region ${{ env.AWS_REGION }} >> $GITHUB_STEP_SUMMARY 2>&1 || \
          aws cloudformation rollback-stack \
          --stack-name retrieval-agent-stack \
          --region ${{ env.AWS_REGION }} >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo "Rollback attempted" >> $GITHUB_STEP_SUMMARY